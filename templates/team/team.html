{% extends 'base.html' %}

{% block head %}
<!-- <script src="{{ url_for('static', filename='javascript/match.js') }}" defer></script>
<link rel="stylesheet" href="{{ url_for('static', filename='stylesheets/match.css') }}"> -->
<link rel="preload" href="{{ url_for('static', filename='stylesheets/team.css') }}" as="style">
<link rel="stylesheet" href="{{ url_for('static',filename='stylesheets/team.css') }}">
{% endblock %}

{% block title %}Team {{ team["number"] }} - {{ team["shortName"] }}{% endblock %}

{% block content %}
{% set previousPage = url_for("teamPage") %}
{% include 'backButton.html' %}
<div class="card">
<h1>Team {{ team["number"] }}</h1>

<h2>{{ team["shortName"] }}</h2>
<p class="teamLong">{{ team["longName"] }}</p>

</div>

<div class="card">
    <h1>Pit Scouting</h1>
    {% if team["pitScout"] %}
    <div>
        <p>Scouted by: </p>
        <select id="pitScoutSelect" onchange="updatePitScout()">
            <!-- <option value="0" selected>None</option> -->
            {% for pitScout in team["pitScout"]%}
            <option value="{{loop.index}}" {% if loop.last %}selected{% endif %}>{{pitScout["user"]}}</option>
            {% endfor %}
        </select>
        {% for pitScout in team["pitScout"]%}
        {% set data = pitScout['data'] %}
        <div class="pit-scout pit-{{loop.index}} hidden">
            <p>Drivebase: {{data["drivebase"]}}</p>
            <p>Languages: </p>
            <ul>
                {% if data["languages"]["java"] %}<li>Java</li>{% endif %}
                {% if data["languages"]["c++"] %}<li>C++</li>{% endif %}
                {% if data["languages"]["python"] %}<li>Python</li>{% endif %}
                {% if data["languages"]["labview"] %}<li>LabView</li>{% endif %}
                {% if data["languages"]["other"] %}<li>{{data["languages"]["other"]}}</li>{% endif %}
            </ul>
            <p>Do they currently have a camera on their robot? {{data["camera"]}}</p>
            <h3>Auto:</h3>
            <ul>
                <li class="{{'checked' if data['auto']['leave'] else 'unchecked'}}">They {{ "" if data["auto"]["leave"] else "cannot"}} leave</li>
                <li class="{{'checked' if data['auto']['algae'] else 'unchecked'}}">They {{ "can" if data["auto"]["algae"] else "cannot"}} remove algae</li>
                <li class="{{'checked' if (data['auto']['reef'])|any else 'unchecked'}}">Reef:</li>
                <ul>
                    {% for canscore in data["auto"]["reef"]%}
                    <li class="{{'checked' if canscore else 'unchecked'}}">They {{"can" if canscore else "cannot"}} score on L{{loop.index}}</li>
                    {%endfor%}
                </ul>
                <li class="{{'checked' if data['auto']['processor'] else 'unchecked'}}">They {{"can" if data["auto"]["processor"] else "cannot"}} score on processor</li>
                <li class="{{'checked' if data['auto']['net'] else 'unchecked'}}">They {{"can" if data["auto"]["net"] else "cannot"}} score on net</li>
            </ul>
            <h3>Tele:</h3>
            <ul>
                <li class="{{'checked' if data['tele']['algae'] else 'unchecked'}}">They {{ "can" if data["tele"]["algae"] else "cannot"}} remove algae</li>
                <li class="{{'checked' if (data['tele']['reef'])|any else 'unchecked'}}">Reef:</li>
                <ul>
                    {% for canscore in data["tele"]["reef"]%}
                    <li class="{{'checked' if canscore else 'unchecked'}}">They {{"can" if canscore else "cannot"}} score on L{{loop.index}}</li>
                    {%endfor%}
                </ul>
                <li class="{{'checked' if data['tele']['processor'] else 'unchecked'}}">They {{"can" if data["tele"]["processor"] else "cannot"}} score on processor</li>
                <li class="{{'checked' if data['tele']['net'] else 'unchecked'}}">They {{"can" if data["tele"]["net"] else "cannot"}} score on net</li>
                <li class="{{'checked' if data['tele']['park'] else 'unchecked'}}">They {{"can" if data["tele"]["parl"] else "cannot"}} park during endgame</li>
                {% if data['tele']['shallow']%}<li class="checked">They can shallow climb</li>{%endif%}
                {% if data['tele']['shallow']%}<li class="checked">They can deep climb</li>{%endif%}
            </ul>
            <p>Main robot role: {{data["role"]}}</p>
            <p>Robot weight: {{data["weight"]}}</p>
            <p>Pit organization: {{data["organization"]}}</p>
            {% if data['special'] %}
            <p>Special information: {{data['special']}}</p>
            {% endif %}
            {% if data['comment'] %}
            <p>Comment: {{data['comment']}}</p>
            {% endif %}
            <!-- {{data}} -->
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <a href="{{url_for('scoutTeam',team=team['number'])}}">Scout this team</a>
</div>

{% if team["images"] %}
<div id="teamImagesContainer">
        <div id="leftArrow" class="imageNav" onclick="changeImage(false)">&#xe5c4</div>
        <div id="rightArrow" class="imageNav" onclick="changeImage(true)">&#xe5c8</div>
    <div id="teamImages">
        {% for image in team["images"] %}
        <div style="background-image:url({{ url_for('static', filename=image['location']) }})" class="teamImage" id="img{{ loop.index0 }}"></div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- <div class="card">
<h2>Comments</h2>
{% for comment in team["comments"] %}
<p>{{ comment["user"] }}: {{ comment["comment"] }}</p>
{% endfor %}
{% if not team["comments"] %}
<p>No comments :(</p>
{% endif %}
</div> -->

<div class="card">
<a href="{{ url_for('addTeamImagePage', team=team['number']) }}">Add an image</a>
<!-- <a href="{{ url_for('setTeamComment', team=team['number']) }}">Add team comment</a> -->
</div>

<div class="card">
<h2>Statistics</h2>
<select name="stats" id="stats" onchange="changeStat()">
    {% for key, value in stats.items()%}
    <option value="{{ key }}">{{ keyDisplayNames[key] }}</option>
    {% endfor %}
</select>
{% for key, value in stats.items() %}
<div id="{{ key }}" class="statistic hidden">
<h3>{{ keyDisplayNames[key] }}</h3>
    <ul>
        <li>Mean: {{ value["mean"] }}</li>
        <li>Median: {{ value["median"] }}</li>
        <li>Mode: {{ value["mode"] }}</li>
        <li>Lowest: {{ value["lowestMatch"]["value"] }}{% if value["lowestMatch"]["displayName"]%} in <a href="{{ url_for('renderMatch',matchNum=value['lowestMatch']['matchNumber'],setNum=value['lowestMatch']['setNumber'],compLevel=value['lowestMatch']['compLevel']) }}">{{ value['lowestMatch']['displayName'] }}</a>{% endif %}</li>
        <li>Highest: {{ value["highestMatch"]["value"] }}{% if value["highestMatch"]["displayName"]%} in <a href="{{ url_for('renderMatch',matchNum=value['highestMatch']['matchNumber'],setNum=value['highestMatch']['setNumber'],compLevel=value['highestMatch']['compLevel']) }}">{{ value['highestMatch']['displayName'] }}</a>{% endif %}</li>
    </ul>
</div>
{% endfor %}
</div>

<!--<p>{{ team }}</p>-->

<div class="card">
<h2>Matches</h2>
<ul>
    {% for match in matches %}
    <li>
        <a href="{{ url_for('renderMatch',matchNum=match['matchNumber'],setNum=match['setNumber'],compLevel=match['compLevel']) }}">{{match['displayName']}}</a>
        {% for section in ["red1","red2","red3","blue1","blue2","blue3"] %}
        {% if match['teams'][section] == team["number"]%}
        {% if section in match['results']%}
        {% if match['results'][section]|length > 0 %}
        <p>Score Impact: {{match['results'][section][-1]['score']}} (scouted by {{match['results'][section][-1]['scout']}})</p>
        {% endif %}
        {% endif %}
        {% endif %}
        {% endfor %}
    </li>
    {% endfor %}
</ul>
</div>

{% if team["pitScout"] %}
<script>
    function updatePitScout(){
        let visible = document.getElementById("pitScoutSelect").value;
        let visibleClass = "pit-"+visible;
        for (const pitScout of document.querySelectorAll(".pit-scout")){
            pitScout.classList.add("hidden");
            if (pitScout.classList.contains(visibleClass)){
                pitScout.classList.remove("hidden")
            }
        }
    }
    addEventListener("DOMContentLoaded",updatePitScout());
</script>
{% endif %}

{% if team["images"] %}
<script>
    const images = document.getElementById("teamImages");
    let currentImage = 0;
    const numberOfImages = {{ team["images"]|length -1 }};

    const options = {
        root: null,
        rootMargin: "0px",
        scrollMargin: "0px",
        threshold: 0.7,
    };

    

    let imageList = [];
    for (let i = 0; i < numberOfImages+1; i++) {
        imageList.push(document.getElementById("img"+i));
    }
    //console.log(imageList);

    const callback = (entries, observer) => {
        entries.forEach((entry) =>{
            currentImage = imageList.indexOf(entry.target);
            //console.log("detected a change: "+currentImage);
        });
    }

    addEventListener("DOMContentLoaded", (event) => {
        images.scrollLeft = 0;
        currentImage = 0;
    })

    function changeImage(next) {
        if (next && currentImage < numberOfImages){
            currentImage += 1;
        } else if (!next && currentImage > 0){
            currentImage -= 1;
        }

        //console.log("current image: "+currentImage);
        document.getElementById("img"+currentImage).scrollIntoView({behavior:"smooth"});
    }

    const observer = new IntersectionObserver(callback, options);
    for (i = imageList.length-1; i >= 0; i--){
        observer.observe(imageList[i]);
    }
</script>
{% endif %}

<script>
    const dropdown = document.getElementById("stats")

    function changeStat(){
        var stat = dropdown.value;
        var listItem = document.getElementById(stat);
        listItem.classList.remove("hidden");
        var activeItems = document.getElementsByClassName("active");
        for (i=0; i < activeItems.length; i++){
            var activeItem = activeItems[i]
            activeItem.classList.remove("active");
            activeItem.classList.add("hidden");
        }
        listItem.classList.add("active");
    }

    addEventListener("DOMContentLoaded", changeStat())
</script>

{% endblock %}