{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<h1>Manage Users</h1>
<ul>
{% for user in users %}
<li>
    <div>
        <h2>{{ user["username"] }}</h2>
        {% if user["admin"] %}
        <p>This user is an admin.</p>
        {% else %}
        {% if user["approved"] %}
        <button id="button_{{ user['username'] }}" onclick="sendApprovalRequest('{{ user['username'] }}',false)">Unapprove User</button>
        {% else %}
        <button id="button_{{ user['username'] }}" onclick="sendApprovalRequest('{{user['username']}}',true)">Approve User</button>
        {% endif %}
        <p id="error_{{ user['username'] }}" style="display: none; color:red;">Error</p>
        {% endif %}
    </div>
</li>
{% endfor %}
</ul>

<script>
    function sendApprovalRequest(username,approved){
        data = JSON.stringify({"username": username, "approved": approved});
        error = document.getElementById("error_"+username);
        button = document.getElementById("button_"+username);
        fetch(window.location.href, {
            method: "POST",
            body: data,
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        }).then(response => {
            if (response.ok){
                error.style =  "display: none; color:red;";
                button.innerHTML = approved ? "Unapprove User" : "Approve User";
                button.setAttribute("onclick","sendApprovalRequest('" + username + "'," + (!approved).toString() + ")");
            } else{
                error.style =  "display: inline; color:red;";
            };
        });
        
    };
</script>

{% endblock %}